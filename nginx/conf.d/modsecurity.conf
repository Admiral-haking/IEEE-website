# ModSecurity Configuration
# Note: This requires ModSecurity module to be installed

# Enable ModSecurity
modsecurity on;
modsecurity_rules_file /etc/nginx/modsecurity/modsecurity.conf;

# OWASP Core Rule Set
modsecurity_rules_file /etc/nginx/modsecurity/crs-setup.conf;
modsecurity_rules_file /etc/nginx/modsecurity/rules/*.conf;

# Custom rules for Hippogriff
modsecurity_rules '
    # Block SQL injection attempts
    SecRule ARGS "@detectSQLi" \
        "id:1001,phase:2,block,msg:\"SQL Injection Attack Detected\",logdata:\"Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}\""

    # Block XSS attempts
    SecRule ARGS "@detectXSS" \
        "id:1002,phase:2,block,msg:\"XSS Attack Detected\",logdata:\"Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}\""

    # Block file upload attacks
    SecRule FILES_NAMES "@rx \\.(php|asp|aspx|jsp|sh|bat|exe)$" \
        "id:1003,phase:2,block,msg:\"Malicious File Upload Attempt\",logdata:\"Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}\""

    # Block command injection
    SecRule ARGS "@rx (;|\\||&|`|\\$)" \
        "id:1004,phase:2,block,msg:\"Command Injection Attempt\",logdata:\"Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}\""

    # Block directory traversal
    SecRule ARGS "@rx \\.\\./" \
        "id:1005,phase:2,block,msg:\"Directory Traversal Attempt\",logdata:\"Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}\""

    # Block suspicious user agents
    SecRule REQUEST_HEADERS:User-Agent "@rx (sqlmap|nikto|nmap|masscan|havij|acunetix)" \
        "id:1006,phase:1,block,msg:\"Malicious User Agent Detected\""

    # Block requests with suspicious content length
    SecRule REQUEST_HEADERS:Content-Length "@gt 10485760" \
        "id:1007,phase:1,block,msg:\"Request Too Large\""

    # Block requests with suspicious content type
    SecRule REQUEST_HEADERS:Content-Type "@rx (application/octet-stream|text/plain)" \
        "id:1008,phase:1,block,msg:\"Suspicious Content Type\""

    # Block requests with suspicious referer
    SecRule REQUEST_HEADERS:Referer "@rx (javascript:|data:|vbscript:)" \
        "id:1009,phase:1,block,msg:\"Suspicious Referer Header\""

    # Block requests with suspicious host header
    SecRule REQUEST_HEADERS:Host "@rx (localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0)" \
        "id:1010,phase:1,block,msg:\"Suspicious Host Header\""
';
