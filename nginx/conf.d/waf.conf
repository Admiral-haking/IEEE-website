# Web Application Firewall (WAF) Configuration

# Block common attack patterns
map $request_uri $blocked_uri {
    ~*\.(php|asp|aspx|jsp)$ 1;
    ~*/(admin|wp-admin|wp-login) 1;
    ~*/(\.git|\.svn|\.env) 1;
    ~*/(config|backup|test) 1;
    default 0;
}

# Block suspicious user agents
map $http_user_agent $blocked_agent {
    ~*(bot|crawler|spider|scraper) 0;
    ~*(sqlmap|nikto|nmap|masscan) 1;
    ~*(curl|wget|python|java) 1;
    default 0;
}

# Block suspicious request methods
map $request_method $blocked_method {
    ~*(GET|POST|PUT|DELETE|PATCH) 0;
    default 1;
}

# Rate limiting for different endpoints
limit_req_zone $binary_remote_addr zone=login:10m rate=3r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=upload:10m rate=1r/s;

# Block requests based on WAF rules
if ($blocked_uri) {
    return 403;
}

if ($blocked_agent) {
    return 403;
}

if ($blocked_method) {
    return 405;
}

# Block requests with suspicious headers
if ($http_x_forwarded_for ~* "127\.0\.0\.1|localhost") {
    return 403;
}

# Block requests with suspicious content
if ($request_body ~* "(union|select|insert|delete|update|drop|create|alter)") {
    return 403;
}
